name: Daily Jobs

on:
  schedule:
    # Run all update scripts every 30 minutes
    - cron: "*/30 * * * *"
  workflow_dispatch: # Allow manual trigger
    inputs:
      job:
        description: "Which job to run (prices, metrics, daily-check, or all)"
        required: false
        default: "all"
        type: choice
        options:
          - all
          - prices
          - metrics
          - daily-check

jobs:
  price-ingestion:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.job == 'all' || github.event.inputs.job == 'prices'))
    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: |
          npm ci
          cd infra/scripts
          npm ci

      - name: Generate Prisma Client
        run: npm --workspace apps/backend run prisma:generate

      - name: Run price ingestion
        working-directory: infra/scripts
        run: npm run prices:ingest
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DIRECT_URL: ${{ secrets.DATABASE_URL }}

  metrics-refresh:
    runs-on: ubuntu-latest
    needs: price-ingestion
    if: |
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.job == 'all' || github.event.inputs.job == 'metrics'))
    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: |
          npm ci
          cd infra/scripts
          npm ci

      - name: Generate Prisma Client
        run: npm --workspace apps/backend run prisma:generate

      - name: Run metrics refresh
        working-directory: infra/scripts
        run: npm run metrics:refresh
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DIRECT_URL: ${{ secrets.DATABASE_URL }}

  daily-check:
    runs-on: ubuntu-latest
    needs: metrics-refresh
    if: |
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.job == 'all' || github.event.inputs.job == 'daily-check'))
    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: |
          npm ci
          cd infra/scripts
          npm ci

      - name: Generate Prisma Client
        run: npm --workspace apps/backend run prisma:generate

      - name: Run daily check
        working-directory: infra/scripts
        run: npm run daily:check
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DIRECT_URL: ${{ secrets.DATABASE_URL }}
