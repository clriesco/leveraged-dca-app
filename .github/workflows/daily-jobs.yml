name: Daily Jobs

on:
  schedule:
    # Run all update scripts every 30 minutes
    - cron: "*/30 * * * *"
  workflow_dispatch: # Allow manual trigger
    inputs:
      job:
        description: "Which job to run (prices, metrics, daily-check, or all)"
        required: false
        default: "all"
        type: choice
        options:
          - all
          - prices
          - metrics
          - daily-check

jobs:
  price-ingestion:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.job == 'all' || github.event.inputs.job == 'prices'))
    steps:
      - name: Call price ingestion endpoint
        run: |
          BACKEND_URL="${{ secrets.BACKEND_URL }}"
          CRON_TOKEN="${{ secrets.CRON_SECRET_TOKEN }}"
          
          if [ -z "$BACKEND_URL" ]; then
            echo "‚ö†Ô∏è  BACKEND_URL secret not set. Skipping."
            exit 0
          fi
          
          if [ -z "$CRON_TOKEN" ]; then
            echo "‚ö†Ô∏è  CRON_SECRET_TOKEN secret not set. Skipping."
            exit 0
          fi
          
          echo "üîÑ Calling price ingestion endpoint..."
          response=$(curl -s -w "\n%{http_code}" \
            -H "Authorization: Bearer $CRON_TOKEN" \
            "$BACKEND_URL/api/cron/price-ingestion" || echo -e "\n000")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          if [ "$http_code" = "200" ]; then
            echo "‚úÖ Price ingestion completed successfully"
            echo "$body" | jq '.' 2>/dev/null || echo "$body"
          else
            echo "‚ùå Price ingestion failed with HTTP $http_code"
            echo "$body"
            exit 1
          fi

  metrics-refresh:
    runs-on: ubuntu-latest
    needs: price-ingestion
    if: |
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.job == 'all' || github.event.inputs.job == 'metrics'))
    steps:
      - name: Call metrics refresh endpoint
        run: |
          BACKEND_URL="${{ secrets.BACKEND_URL }}"
          CRON_TOKEN="${{ secrets.CRON_SECRET_TOKEN }}"
          
          if [ -z "$BACKEND_URL" ]; then
            echo "‚ö†Ô∏è  BACKEND_URL secret not set. Skipping."
            exit 0
          fi
          
          if [ -z "$CRON_TOKEN" ]; then
            echo "‚ö†Ô∏è  CRON_SECRET_TOKEN secret not set. Skipping."
            exit 0
          fi
          
          echo "üîÑ Calling metrics refresh endpoint..."
          response=$(curl -s -w "\n%{http_code}" \
            -H "Authorization: Bearer $CRON_TOKEN" \
            "$BACKEND_URL/api/cron/metrics-refresh" || echo -e "\n000")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          if [ "$http_code" = "200" ]; then
            echo "‚úÖ Metrics refresh completed successfully"
            echo "$body" | jq '.' 2>/dev/null || echo "$body"
          else
            echo "‚ùå Metrics refresh failed with HTTP $http_code"
            echo "$body"
            exit 1
          fi

  daily-check:
    runs-on: ubuntu-latest
    needs: metrics-refresh
    if: |
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.job == 'all' || github.event.inputs.job == 'daily-check'))
    steps:
      - name: Call daily check endpoint
        run: |
          BACKEND_URL="${{ secrets.BACKEND_URL }}"
          CRON_TOKEN="${{ secrets.CRON_SECRET_TOKEN }}"
          
          if [ -z "$BACKEND_URL" ]; then
            echo "‚ö†Ô∏è  BACKEND_URL secret not set. Skipping."
            exit 0
          fi
          
          if [ -z "$CRON_TOKEN" ]; then
            echo "‚ö†Ô∏è  CRON_SECRET_TOKEN secret not set. Skipping."
            exit 0
          fi
          
          echo "üîç Calling daily check endpoint..."
          response=$(curl -s -w "\n%{http_code}" \
            -H "Authorization: Bearer $CRON_TOKEN" \
            "$BACKEND_URL/api/cron/daily-check" || echo -e "\n000")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          if [ "$http_code" = "200" ]; then
            echo "‚úÖ Daily check completed successfully"
            echo "$body" | jq '.' 2>/dev/null || echo "$body"
          else
            echo "‚ùå Daily check failed with HTTP $http_code"
            echo "$body"
            exit 1
          fi
