name: Daily Jobs

on:
  schedule:
    # Price ingestion at 6:00 AM UTC
    - cron: "0 6 * * *"
    # Metrics refresh at 7:00 AM UTC
    - cron: "0 7 * * *"
    # Daily check at 9:00 AM UTC
    - cron: "0 9 * * *"
  workflow_dispatch: # Allow manual trigger
    inputs:
      job:
        description: "Which job to run (prices, metrics, daily-check, or all)"
        required: false
        default: "all"
        type: choice
        options:
          - all
          - prices
          - metrics
          - daily-check

jobs:
  price-ingestion:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'schedule' && github.run_attempt == 1) ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.job == 'all' || github.event.inputs.job == 'prices'))
    steps:
      - name: Check if should run (6:00 AM UTC)
        id: check-time
        run: |
          CURRENT_HOUR=$(date -u +%H)
          if [ "$CURRENT_HOUR" = "06" ] || [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "Skipping: Current hour is $CURRENT_HOUR UTC, expected 06 UTC"
          fi

      - uses: actions/checkout@v4
        if: steps.check-time.outputs.should_run == 'true'

      - name: Use Node.js
        if: steps.check-time.outputs.should_run == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        if: steps.check-time.outputs.should_run == 'true'
        run: |
          npm ci
          cd infra/scripts
          npm ci

      - name: Generate Prisma Client
        if: steps.check-time.outputs.should_run == 'true'
        run: npm --workspace apps/backend run prisma:generate

      - name: Run price ingestion
        if: steps.check-time.outputs.should_run == 'true'
        working-directory: infra/scripts
        run: npm run prices:ingest
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DIRECT_URL: ${{ secrets.DATABASE_URL }}

  metrics-refresh:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'schedule' && github.run_attempt == 1) ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.job == 'all' || github.event.inputs.job == 'metrics'))
    steps:
      - name: Check if should run (7:00 AM UTC)
        id: check-time
        run: |
          CURRENT_HOUR=$(date -u +%H)
          if [ "$CURRENT_HOUR" = "07" ] || [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "Skipping: Current hour is $CURRENT_HOUR UTC, expected 07 UTC"
          fi

      - uses: actions/checkout@v4
        if: steps.check-time.outputs.should_run == 'true'

      - name: Use Node.js
        if: steps.check-time.outputs.should_run == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        if: steps.check-time.outputs.should_run == 'true'
        run: |
          npm ci
          cd infra/scripts
          npm ci

      - name: Generate Prisma Client
        if: steps.check-time.outputs.should_run == 'true'
        run: npm --workspace apps/backend run prisma:generate

      - name: Run metrics refresh
        if: steps.check-time.outputs.should_run == 'true'
        working-directory: infra/scripts
        run: npm run metrics:refresh
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DIRECT_URL: ${{ secrets.DATABASE_URL }}

  daily-check:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'schedule' && github.run_attempt == 1) ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.job == 'all' || github.event.inputs.job == 'daily-check'))
    steps:
      - name: Check if should run (9:00 AM UTC)
        id: check-time
        run: |
          CURRENT_HOUR=$(date -u +%H)
          if [ "$CURRENT_HOUR" = "09" ] || [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "Skipping: Current hour is $CURRENT_HOUR UTC, expected 09 UTC"
          fi

      - uses: actions/checkout@v4
        if: steps.check-time.outputs.should_run == 'true'

      - name: Use Node.js
        if: steps.check-time.outputs.should_run == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        if: steps.check-time.outputs.should_run == 'true'
        run: |
          npm ci
          cd infra/scripts
          npm ci

      - name: Generate Prisma Client
        if: steps.check-time.outputs.should_run == 'true'
        run: npm --workspace apps/backend run prisma:generate

      - name: Run daily check
        if: steps.check-time.outputs.should_run == 'true'
        working-directory: infra/scripts
        run: npm run daily:check
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DIRECT_URL: ${{ secrets.DATABASE_URL }}
